<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SVG Necromancer - AI-powered SVG tool. Generate, Fix, Animate, and Convert vectors using Gemini AI.">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 img-src 'self' data: blob:;
                 connect-src https://generativelanguage.googleapis.com;">
  <title>SVG Necromancer | „Éô„ÇØ„Çø„Éº„ÇíËòá„Çâ„Åõ„Çã</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ========================================
       CSS CUSTOM PROPERTIES / THEME
       ======================================== */
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #0d0d14;
      --accent-pink: #ff3366;
      --accent-pink-light: #ff6b9d;
      --accent-pink-glow: rgba(255, 51, 102, 0.3);
      --accent-blue: #0066cc;
      --accent-blue-light: #3399ff;
      --text-primary: #e8e8e8;
      --text-muted: #a0a8b0;
      --border: #2a2a3a;
      --border-light: #3a3a4a;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 12px;
    }

    /* ========================================
       CSS RESET / BASE
       ======================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Focus styles */
    *:focus {
      outline: none;
    }

    *:focus-visible {
      outline: 2px solid var(--accent-pink);
      outline-offset: 2px;
    }

    /* Visually hidden utility */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Skip link */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 16px;
      background: var(--accent-pink);
      color: #fff;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      z-index: 9999;
      text-decoration: none;
      transition: top var(--transition-fast);
    }

    .skip-link:focus {
      top: 16px;
    }

    /* ========================================
       LAYOUT COMPONENTS
       ======================================== */
    .container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255, 51, 102, 0.1);
      background: rgba(18, 18, 26, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .header-left {
      display: flex;
      align-items: baseline;
      gap: 12px;
    }

    .logo {
      font-size: 24px;
      font-weight: 800;
      font-style: italic;
      color: var(--accent-pink);
      letter-spacing: -0.5px;
      text-transform: uppercase;
    }

    .tagline-jp {
      color: var(--accent-blue);
      font-size: 14px;
      font-weight: 500;
    }

    /* Main Layout */
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .left-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      overflow: hidden;
      min-width: 300px;
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-tertiary);
      min-width: 300px;
    }

    /* Footer */
    .footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--bg-primary);
      text-align: center;
    }

    .footer-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .footer-badge {
      background: var(--accent-blue);
      color: #fff;
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
    }

    .footer-link {
      color: var(--accent-pink);
      text-decoration: none;
      font-weight: 600;
      transition: color var(--transition-fast);
    }

    .footer-link:hover {
      color: var(--accent-pink-light);
    }

    .footer-tagline {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ========================================
       UI COMPONENTS - BUTTONS
       ======================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }

    /* Button shine effect */
    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s;
    }

    .btn:hover::before {
      transform: translateX(100%);
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-pink-light) 100%);
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--accent-pink-glow);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--accent-pink);
      color: var(--accent-pink);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(255, 51, 102, 0.1);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-ghost:hover:not(:disabled) {
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(255, 51, 102, 0.1);
      border: 1px solid var(--accent-pink);
      color: var(--accent-pink);
    }

    .btn-export {
      flex: 1;
      padding: 10px 16px;
      background: rgba(0, 102, 204, 0.1);
      border: 1px solid var(--accent-blue);
      color: var(--accent-blue);
      font-size: 13px;
      font-weight: 500;
    }

    .btn-export:hover:not(:disabled) {
      background: rgba(0, 102, 204, 0.2);
    }

    /* API Key Button */
    .key-btn {
      padding: 8px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all var(--transition-fast);
      border: 1px solid;
      background: transparent;
      font-family: inherit;
    }

    .key-btn.set {
      background: rgba(0, 102, 204, 0.2);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }

    .key-btn.empty {
      background: rgba(255, 51, 102, 0.1);
      border-color: var(--accent-pink);
      color: var(--accent-pink);
    }

    .key-btn:hover {
      transform: translateY(-1px);
    }

    /* ========================================
       UI COMPONENTS - FORMS
       ======================================== */
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: border-color var(--transition-fast);
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      border-color: var(--accent-pink);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b949e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .help-text {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.5;
    }

    /* ========================================
       UI COMPONENTS - MODAL
       ======================================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 400px;
      max-width: 100%;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      border-color: var(--accent-pink);
      color: var(--accent-pink);
    }

    .modal h3 {
      color: var(--accent-pink);
      margin-bottom: 8px;
      font-size: 18px;
    }

    .modal p {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .modal a {
      color: var(--accent-blue);
      text-decoration: none;
    }

    .modal a:hover {
      text-decoration: underline;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    /* ========================================
       TAB SYSTEM
       ======================================== */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
      overflow-x: auto;
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: inherit;
      min-width: max-content;
    }

    .tab:hover:not([aria-selected="true"]) {
      background: rgba(255, 51, 102, 0.08);
      transform: translateY(-1px);
    }

    .tab[aria-selected="true"] {
      background: linear-gradient(135deg, rgba(255, 51, 102, 0.15), rgba(255, 51, 102, 0.05));
      color: var(--accent-pink);
      box-shadow:
        inset 0 -2px 0 var(--accent-pink),
        0 0 20px rgba(255, 51, 102, 0.15);
      position: relative;
    }

    .tab[aria-selected="true"]::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-pink), transparent);
      animation: glow-pulse 2s ease-in-out infinite;
    }

    @keyframes glow-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .tab-icon {
      font-size: 18px;
    }

    .tab-label {
      font-size: 13px;
      font-weight: 600;
    }

    .tab-jp {
      font-size: 10px;
      opacity: 0.7;
    }

    /* Tab Panels */
    .tab-panel {
      display: none;
      flex-direction: column;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .tab-panel.active {
      display: flex;
    }

    /* ========================================
       STATUS BAR
       ======================================== */
    .status-bar {
      padding: 10px 24px;
      font-size: 14px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .status-bar.active {
      display: flex;
      animation: slideDownBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideDownBounce {
      0% { opacity: 0; transform: translateY(-20px) scale(0.95); }
      60% { transform: translateY(5px) scale(1.02); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .status-bar.info {
      background: rgba(0, 102, 204, 0.1);
      color: var(--accent-blue);
    }

    .status-bar.success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .status-bar.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .status-bar.loading {
      background: rgba(255, 51, 102, 0.1);
      color: var(--accent-pink);
    }

    /* ========================================
       EDITOR & PREVIEW
       ======================================== */
    .editor-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .editor-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .editor-actions {
      display: flex;
      gap: 8px;
    }

    .code-editor {
      flex: 1;
      padding: 16px 20px;
      background: var(--bg-primary);
      border: none;
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
      resize: none;
      outline: none;
      line-height: 1.6;
      min-height: 200px;
    }

    .code-editor::placeholder {
      color: var(--text-muted);
    }

    /* Custom Scrollbars */
    .code-editor::-webkit-scrollbar,
    .converted-output::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .code-editor::-webkit-scrollbar-track,
    .converted-output::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    .code-editor::-webkit-scrollbar-thumb,
    .converted-output::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .code-editor::-webkit-scrollbar-thumb:hover,
    .converted-output::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Preview */
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .preview-jp {
      font-size: 11px;
      color: var(--accent-blue);
      text-transform: none;
    }

    .preview-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow: auto;
      background: var(--bg-secondary);
      background-image: radial-gradient(circle at 1px 1px, var(--border) 1px, transparent 0);
      background-size: 20px 20px;
      min-height: 300px;
    }

    .preview-area svg {
      max-width: 100%;
      max-height: 100%;
    }

    .preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 40px;
      text-align: center;
      height: 100%;
    }

    .empty-state-icon {
      font-size: 48px;
      opacity: 0.3;
      filter: grayscale(0.5);
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .empty-state-desc {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 240px;
    }

    /* SVG Preview Animation */
    .preview-area svg {
      animation: fadeInScale 0.4s ease;
    }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .export-buttons {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      border-top: 1px solid var(--border);
    }

    /* Converted Output */
    .converted-output {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      display: none;
    }

    .converted-output.active {
      display: block;
    }

    .converted-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      font-size: 12px;
      color: var(--text-muted);
    }

    .converted-code {
      margin: 0;
      padding: 12px;
      background: var(--bg-primary);
      font-size: 11px;
      font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
      color: var(--text-primary);
      overflow: auto;
      max-height: 150px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* ========================================
       ANIMATIONS
       ======================================== */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (max-width: 768px) {
      .main {
        flex-direction: column;
      }

      .left-panel,
      .right-panel {
        min-width: 100%;
        border-right: none;
      }

      .left-panel {
        border-bottom: 1px solid var(--border);
      }

      .preview-area {
        min-height: 250px;
      }

      .header {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }

      .header-left {
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .tabs {
        padding: 12px 16px;
      }

      .tab {
        padding: 10px 14px;
        min-height: 44px;
      }

      .btn {
        min-height: 44px;
      }
    }

    @media (max-width: 480px) {
      .modal-buttons {
        flex-direction: column;
      }

      .export-buttons {
        flex-direction: column;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="container">
    <!-- Header -->
    <header class="header" role="banner">
      <div class="header-left">
        <h1 class="logo">Necromancer</h1>
        <span class="tagline-jp" lang="ja" aria-label="Resurrect your vectors">„Éô„ÇØ„Çø„Éº„ÇíËòá„Çâ„Åõ„Çã</span>
      </div>
      <button id="apiKeyBtn" class="key-btn empty" aria-label="Add API Key">
        üîë Add API Key
      </button>
    </header>

    <!-- API Key Modal -->
    <div id="keyModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc">
      <div class="modal">
        <button class="modal-close" aria-label="Close dialog">&times;</button>
        <h3 id="modal-title">Gemini API Key</h3>
        <p id="modal-desc">Get your free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Google AI Studio</a></p>
        <label for="apiKeyInput" class="visually-hidden">API Key</label>
        <input type="password" id="apiKeyInput" class="form-input" placeholder="AIza..." autocomplete="off">
        <div class="modal-buttons">
          <button id="saveKeyBtn" class="btn btn-primary">Save Key</button>
          <button id="clearKeyBtn" class="btn btn-secondary">Clear</button>
          <button id="cancelKeyBtn" class="btn btn-ghost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tabs" role="tablist" aria-label="SVG tools">
      <button class="tab" role="tab" id="tab-generate" aria-selected="true" aria-controls="panel-generate" data-tab="generate">
        <span class="tab-icon" aria-hidden="true">‚ú®</span>
        <span class="tab-label">Generate</span>
        <span class="tab-jp" lang="ja" aria-hidden="true">Âè¨Âñö</span>
      </button>
      <button class="tab" role="tab" id="tab-view" aria-selected="false" aria-controls="panel-view" data-tab="view" tabindex="-1">
        <span class="tab-icon" aria-hidden="true">üëÅ</span>
        <span class="tab-label">View/Edit</span>
        <span class="tab-jp" lang="ja" aria-hidden="true">Ë°®Á§∫</span>
      </button>
      <button class="tab" role="tab" id="tab-fix" aria-selected="false" aria-controls="panel-fix" data-tab="fix" tabindex="-1">
        <span class="tab-icon" aria-hidden="true">ü©π</span>
        <span class="tab-label">Fix</span>
        <span class="tab-jp" lang="ja" aria-hidden="true">‰øÆÂæ©</span>
      </button>
      <button class="tab" role="tab" id="tab-animate" aria-selected="false" aria-controls="panel-animate" data-tab="animate" tabindex="-1">
        <span class="tab-icon" aria-hidden="true">üé¨</span>
        <span class="tab-label">Animate</span>
        <span class="tab-jp" lang="ja" aria-hidden="true">Âãï‰Ωú</span>
      </button>
      <button class="tab" role="tab" id="tab-convert" aria-selected="false" aria-controls="panel-convert" data-tab="convert" tabindex="-1">
        <span class="tab-icon" aria-hidden="true">‚ö°</span>
        <span class="tab-label">Convert</span>
        <span class="tab-jp" lang="ja" aria-hidden="true">Â§âÊèõ</span>
      </button>
    </nav>

    <!-- Status Bar -->
    <div id="statusBar" class="status-bar" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Main Content -->
    <main id="main-content" class="main">
      <!-- Left Panel -->
      <div class="left-panel">
        <!-- Generate Panel -->
        <div id="panel-generate" class="tab-panel active" role="tabpanel" aria-labelledby="tab-generate">
          <label for="promptInput" class="form-label">Describe your SVG</label>
          <textarea id="promptInput" class="form-textarea" placeholder="A minimalist mountain logo with sun rays..." aria-describedby="prompt-help"></textarea>
          <span id="prompt-help" class="visually-hidden">Describe the SVG you want to generate. Be specific about colors, shapes, and style.</span>
          <button id="generateBtn" class="btn btn-primary">Âè¨Âñö Generate</button>
        </div>

        <!-- View Panel -->
        <div id="panel-view" class="tab-panel" role="tabpanel" aria-labelledby="tab-view">
          <p class="help-text">Paste or edit your SVG code below. Preview updates live.</p>
        </div>

        <!-- Fix Panel -->
        <div id="panel-fix" class="tab-panel" role="tabpanel" aria-labelledby="tab-fix">
          <p class="help-text">Paste your broken SVG below, then click Fix to resurrect it.</p>
          <button id="fixBtn" class="btn btn-primary">ü©π ‰øÆÂæ© Fix SVG</button>
        </div>

        <!-- Animate Panel -->
        <div id="panel-animate" class="tab-panel" role="tabpanel" aria-labelledby="tab-animate">
          <label for="animationType" class="form-label">Animation Type</label>
          <select id="animationType" class="form-select">
            <option value="">Select animation...</option>
            <option value="pulse">Pulse / Breathe</option>
            <option value="spin">Spin / Rotate</option>
            <option value="bounce">Bounce</option>
            <option value="fade">Fade In/Out</option>
            <option value="draw">Draw / Reveal</option>
            <option value="float">Float / Hover</option>
            <option value="shake">Shake / Wiggle</option>
            <option value="glow">Glow</option>
          </select>
          <button id="animateBtn" class="btn btn-primary">üé¨ Apply Animation</button>
        </div>

        <!-- Convert Panel -->
        <div id="panel-convert" class="tab-panel" role="tabpanel" aria-labelledby="tab-convert">
          <label for="convertFormat" class="form-label">Convert To</label>
          <select id="convertFormat" class="form-select">
            <option value="react">React Component</option>
            <option value="vue">Vue Component</option>
            <option value="base64">Base64 Data URI</option>
            <option value="datauri">URL Encoded Data URI</option>
            <option value="optimized">Optimized/Minified</option>
          </select>
          <button id="convertBtn" class="btn btn-primary">‚ö° Â§âÊèõ Convert</button>
          <div id="convertedOutput" class="converted-output">
            <div class="converted-header">
              <span>Output</span>
              <button id="copyConvertedBtn" class="btn-small">Copy</button>
            </div>
            <pre id="convertedCode" class="converted-code"></pre>
          </div>
        </div>

        <!-- Code Editor -->
        <div class="editor-section">
          <div class="editor-header">
            <span class="editor-title">SVG Code</span>
            <div class="editor-actions">
              <button id="copyCodeBtn" class="btn-small">Copy</button>
              <button id="clearCodeBtn" class="btn-small">Clear</button>
            </div>
          </div>
          <label for="svgEditor" class="visually-hidden">SVG Code Editor</label>
          <textarea id="svgEditor" class="code-editor" placeholder="<svg>...</svg>" spellcheck="false" aria-label="SVG code editor"></textarea>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="preview-header">
          <span>Preview</span>
          <span class="preview-jp" lang="ja">„Éó„É¨„Éì„É•„Éº</span>
        </div>
        <div id="previewArea" class="preview-area" aria-label="SVG Preview">
          <div class="preview-placeholder">
            <div class="empty-state-icon">‚ú®</div>
            <div class="empty-state-title">No SVG Yet</div>
            <div class="empty-state-desc">Generate or paste SVG code to see it come to life</div>
          </div>
        </div>
        <div class="export-buttons">
          <button id="downloadSvgBtn" class="btn btn-export">Download SVG</button>
          <button id="downloadPngBtn" class="btn btn-export">Download PNG</button>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
      <div class="footer-brand">
        <span class="footer-badge" lang="ja">ËòáÁîü</span>
        <span>Resurrected by</span>
        <a href="https://undeadlist.com" target="_blank" rel="noopener" class="footer-link">UndeadList</a>
      </div>
      <div class="footer-tagline">The indie software flea market</div>
    </footer>
  </div>

  <script>
    /* ========================================
       CONFIGURATION
       ======================================== */
    const CONFIG = {
      API_ENDPOINT: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent',
      STORAGE_KEY: 'necromancer_api_key',
      MAX_PROMPT_LENGTH: 2000,
      MAX_SVG_LENGTH: 100000,
      STATUS_TIMEOUT: 3000
    };

    const ANIMATIONS = {
      pulse: 'Add a pulsing/breathing animation that scales the SVG slightly. Use transform: scale() with smooth easing.',
      spin: 'Add a continuous rotation animation around the center. Use transform: rotate() with linear timing.',
      bounce: 'Add a bouncing up and down animation. Use transform: translateY() with ease-in-out.',
      fade: 'Add a fade in/out opacity animation. Animate opacity from 0.3 to 1 smoothly.',
      draw: 'Add a stroke drawing animation that reveals the paths. Use stroke-dasharray and stroke-dashoffset animation.',
      float: 'Add a gentle floating/hovering animation with subtle translateY movement.',
      shake: 'Add a shake/wiggle animation. Use small rotate and translate transforms.',
      glow: 'Add a glowing effect animation using filter and drop-shadow that pulses.'
    };

    /* ========================================
       STATE
       ======================================== */
    const AppState = {
      apiKey: null,
      currentTab: 'generate',
      convertedOutput: ''
    };

    /* ========================================
       DOM CACHE
       ======================================== */
    const DOM = {};

    function initDOM() {
      DOM.apiKeyBtn = document.getElementById('apiKeyBtn');
      DOM.keyModal = document.getElementById('keyModal');
      DOM.apiKeyInput = document.getElementById('apiKeyInput');
      DOM.saveKeyBtn = document.getElementById('saveKeyBtn');
      DOM.clearKeyBtn = document.getElementById('clearKeyBtn');
      DOM.cancelKeyBtn = document.getElementById('cancelKeyBtn');
      DOM.modalClose = DOM.keyModal.querySelector('.modal-close');
      DOM.statusBar = document.getElementById('statusBar');
      DOM.svgEditor = document.getElementById('svgEditor');
      DOM.previewArea = document.getElementById('previewArea');
      DOM.promptInput = document.getElementById('promptInput');
      DOM.generateBtn = document.getElementById('generateBtn');
      DOM.fixBtn = document.getElementById('fixBtn');
      DOM.animationType = document.getElementById('animationType');
      DOM.animateBtn = document.getElementById('animateBtn');
      DOM.convertFormat = document.getElementById('convertFormat');
      DOM.convertBtn = document.getElementById('convertBtn');
      DOM.convertedOutput = document.getElementById('convertedOutput');
      DOM.convertedCode = document.getElementById('convertedCode');
      DOM.copyConvertedBtn = document.getElementById('copyConvertedBtn');
      DOM.copyCodeBtn = document.getElementById('copyCodeBtn');
      DOM.clearCodeBtn = document.getElementById('clearCodeBtn');
      DOM.downloadSvgBtn = document.getElementById('downloadSvgBtn');
      DOM.downloadPngBtn = document.getElementById('downloadPngBtn');
      DOM.tabs = document.querySelectorAll('.tab');
      DOM.panels = document.querySelectorAll('.tab-panel');
    }

    /* ========================================
       UTILITIES
       ======================================== */
    const Utils = {
      debounce(fn, delay) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    /* ========================================
       SVG SANITIZER (Security)
       ======================================== */
    const SVGSanitizer = {
      // Extended list to prevent XSS via SVG animation elements
      dangerousElements: ['script', 'foreignObject', 'animate', 'set', 'animateTransform', 'animateMotion'],
      dangerousAttributes: [
        'onload', 'onerror', 'onclick', 'onmouseover', 'onmouseout',
        'onmousedown', 'onmouseup', 'onfocus', 'onblur', 'onchange',
        'onsubmit', 'onreset', 'onselect', 'onabort', 'ondblclick',
        'onkeydown', 'onkeypress', 'onkeyup', 'onmousemove',
        'onbegin', 'onend', 'onrepeat' // SVG animation events
      ],

      sanitize(svgString) {
        if (!svgString || typeof svgString !== 'string') return null;

        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(svgString, 'image/svg+xml');

          const parserError = doc.querySelector('parsererror');
          if (parserError) return null;

          const svg = doc.querySelector('svg');
          if (!svg) return null;

          // Remove dangerous elements
          this.dangerousElements.forEach(tag => {
            svg.querySelectorAll(tag).forEach(el => el.remove());
          });

          // Remove dangerous attributes from all elements
          svg.querySelectorAll('*').forEach(el => {
            this.dangerousAttributes.forEach(attr => {
              el.removeAttribute(attr);
            });

            // Check href for javascript: and data: protocols
            ['href', 'xlink:href'].forEach(attrName => {
              const href = el.getAttribute(attrName);
              if (href) {
                const lowerHref = href.toLowerCase().trim();
                if (lowerHref.startsWith('javascript:') ||
                    (lowerHref.startsWith('data:') && lowerHref.includes('script'))) {
                  el.removeAttribute(attrName);
                }
              }
            });

            // Sanitize style for javascript: and expression()
            const style = el.getAttribute('style');
            if (style && /expression\s*\(|javascript:|behavior\s*:/i.test(style)) {
              el.removeAttribute('style');
            }
          });

          return new XMLSerializer().serializeToString(svg);
        } catch (e) {
          console.error('SVG sanitization error:', e);
          return null;
        }
      }
    };

    /* ========================================
       INPUT VALIDATOR
       ======================================== */
    const InputValidator = {
      validatePrompt(prompt) {
        if (!prompt || typeof prompt !== 'string') return false;
        if (prompt.length > CONFIG.MAX_PROMPT_LENGTH) return false;
        return prompt.trim().length > 0;
      },

      validateSvgCode(code) {
        if (!code || typeof code !== 'string') return false;
        if (code.length > CONFIG.MAX_SVG_LENGTH) return false;
        return /<svg[\s\S]*<\/svg>/i.test(code);
      },

      validateApiKey(key) {
        return key && typeof key === 'string' && key.startsWith('AIza') && key.length > 20;
      }
    };

    /* ========================================
       API KEY CONTROLLER
       ======================================== */
    const ApiKeyController = {
      load() {
        const key = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (InputValidator.validateApiKey(key)) {
          AppState.apiKey = key;
          this.updateButton(true);
          return true;
        }
        return false;
      },

      save(key) {
        if (InputValidator.validateApiKey(key)) {
          localStorage.setItem(CONFIG.STORAGE_KEY, key);
          AppState.apiKey = key;
          this.updateButton(true);
          return true;
        }
        return false;
      },

      clear() {
        localStorage.removeItem(CONFIG.STORAGE_KEY);
        AppState.apiKey = null;
        this.updateButton(false);
      },

      updateButton(hasKey) {
        if (hasKey) {
          DOM.apiKeyBtn.textContent = 'üîë API Key Set';
          DOM.apiKeyBtn.className = 'key-btn set';
        } else {
          DOM.apiKeyBtn.textContent = 'üîë Add API Key';
          DOM.apiKeyBtn.className = 'key-btn empty';
        }
      }
    };

    /* ========================================
       MODAL CONTROLLER
       ======================================== */
    const ModalController = {
      previousFocus: null,

      open(modalId) {
        this.previousFocus = document.activeElement;
        const modal = document.getElementById(modalId);
        modal.classList.add('active');

        // Pre-fill with current key if exists
        if (modalId === 'keyModal' && AppState.apiKey) {
          DOM.apiKeyInput.value = AppState.apiKey;
        }

        const firstFocusable = modal.querySelector('input, button:not(.modal-close)');
        if (firstFocusable) {
          setTimeout(() => firstFocusable.focus(), 50);
        }

        this.boundKeyHandler = this.handleKeydown.bind(this, modal);
        modal.addEventListener('keydown', this.boundKeyHandler);
      },

      close(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('active');
        modal.removeEventListener('keydown', this.boundKeyHandler);

        if (this.previousFocus) {
          this.previousFocus.focus();
        }
      },

      handleKeydown(modal, e) {
        if (e.key === 'Escape') {
          this.close(modal.id);
        }

        if (e.key === 'Tab') {
          const focusables = modal.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
          const first = focusables[0];
          const last = focusables[focusables.length - 1];

          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    };

    /* ========================================
       STATUS CONTROLLER
       ======================================== */
    const StatusController = {
      timeout: null,

      show(message, type = 'info') {
        clearTimeout(this.timeout);
        DOM.statusBar.textContent = message;
        DOM.statusBar.className = `status-bar active ${type}`;

        if (type !== 'loading') {
          this.timeout = setTimeout(() => this.clear(), CONFIG.STATUS_TIMEOUT);
        }
      },

      showLoading(message) {
        clearTimeout(this.timeout);
        // Safely create spinner element
        DOM.statusBar.textContent = '';
        const spinner = document.createElement('span');
        spinner.className = 'loading-spinner';
        spinner.setAttribute('aria-hidden', 'true');
        DOM.statusBar.appendChild(spinner);
        DOM.statusBar.appendChild(document.createTextNode(' ' + message));
        DOM.statusBar.className = 'status-bar active loading';
      },

      clear() {
        clearTimeout(this.timeout);
        DOM.statusBar.className = 'status-bar';
        DOM.statusBar.textContent = '';
      }
    };

    /* ========================================
       TAB CONTROLLER
       ======================================== */
    const TabController = {
      switch(tabId) {
        AppState.currentTab = tabId;

        DOM.tabs.forEach(tab => {
          const isSelected = tab.dataset.tab === tabId;
          tab.setAttribute('aria-selected', isSelected);
          tab.tabIndex = isSelected ? 0 : -1;
        });

        DOM.panels.forEach(panel => {
          const isActive = panel.id === `panel-${tabId}`;
          panel.classList.toggle('active', isActive);
        });

        // Focus the selected tab for accessibility
        const selectedTab = document.querySelector(`[data-tab="${tabId}"]`);
        if (selectedTab && document.activeElement?.classList.contains('tab')) {
          selectedTab.focus();
        }
      },

      handleKeydown(e) {
        const tabs = Array.from(DOM.tabs);
        const currentIndex = tabs.findIndex(t => t.dataset.tab === AppState.currentTab);

        let nextIndex;
        if (e.key === 'ArrowRight') {
          nextIndex = (currentIndex + 1) % tabs.length;
        } else if (e.key === 'ArrowLeft') {
          nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        } else if (e.key === 'Home') {
          nextIndex = 0;
        } else if (e.key === 'End') {
          nextIndex = tabs.length - 1;
        } else {
          return;
        }

        e.preventDefault();
        tabs[nextIndex].focus();
        this.switch(tabs[nextIndex].dataset.tab);
      }
    };

    /* ========================================
       PREVIEW CONTROLLER
       ======================================== */
    const PreviewController = {
      update() {
        const rawSvg = DOM.svgEditor.value;

        if (!rawSvg.trim()) {
          DOM.previewArea.innerHTML = '<div class="preview-placeholder"><div class="empty-state-icon">‚ú®</div><div class="empty-state-title">No SVG Yet</div><div class="empty-state-desc">Generate or paste SVG code to see it come to life</div></div>';
          return;
        }

        const sanitizedSvg = SVGSanitizer.sanitize(rawSvg);

        if (sanitizedSvg) {
          DOM.previewArea.innerHTML = sanitizedSvg;
        } else {
          DOM.previewArea.innerHTML = '<p class="preview-placeholder" style="color: var(--error);">Invalid SVG code</p>';
        }
      }
    };

    /* ========================================
       GEMINI API (with rate limiting & request cancellation)
       ======================================== */
    const GeminiAPI = {
      lastRequestTime: 0,
      minRequestInterval: 2000, // 2 seconds between requests
      currentController: null,

      async call(prompt, systemPrompt) {
        if (!AppState.apiKey) {
          StatusController.show('Please add your Gemini API key first', 'error');
          ModalController.open('keyModal');
          return null;
        }

        // Rate limiting
        const now = Date.now();
        const timeSinceLastRequest = now - this.lastRequestTime;
        if (timeSinceLastRequest < this.minRequestInterval) {
          StatusController.show('Please wait before making another request', 'error');
          return null;
        }

        // Cancel any pending request
        if (this.currentController) {
          this.currentController.abort();
        }
        this.currentController = new AbortController();
        this.lastRequestTime = now;

        StatusController.showLoading('ÈôçÈúä‰∏≠... Summoning...');

        try {
          const response = await fetch(CONFIG.API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': AppState.apiKey
            },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: `${systemPrompt}\n\nUser request: ${prompt}` }]
              }],
              generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 4096
              }
            }),
            signal: this.currentController.signal
          });

          const data = await response.json();

          if (data.error) {
            // Handle specific error codes
            if (data.error.code === 401 || data.error.code === 403) {
              StatusController.show('Invalid API key. Please check your key.', 'error');
              ModalController.open('keyModal');
              return null;
            }
            throw new Error(data.error.message);
          }

          let text = '';
          if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            text = data.candidates[0].content.parts[0].text;
          }

          const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/i);

          if (svgMatch) {
            StatusController.show('Âæ©Ê¥ªÔºÅ Revived!', 'success');
            return svgMatch[0];
          } else {
            StatusController.show('No SVG found in response', 'error');
            return null;
          }
        } catch (error) {
          if (error.name === 'AbortError') {
            return null; // Request was cancelled, no error message needed
          }
          StatusController.show(`Error: ${error.message}`, 'error');
          return null;
        } finally {
          this.currentController = null;
        }
      }
    };

    /* ========================================
       GENERATE CONTROLLER
       ======================================== */
    const GenerateController = {
      async handle() {
        const prompt = DOM.promptInput.value.trim();

        if (!InputValidator.validatePrompt(prompt)) {
          StatusController.show('Please enter a description', 'error');
          return;
        }

        DOM.generateBtn.disabled = true;
        DOM.generateBtn.textContent = 'ÈôçÈúä‰∏≠...';

        const systemPrompt = `You are an SVG generator. Create clean, optimized SVG code based on the user's description.
Return ONLY the SVG code, no explanation, no markdown code blocks.
The SVG should:
- Use viewBox for scalability (e.g., viewBox="0 0 100 100")
- Be well-structured and minimal
- Include width and height attributes
- Use appropriate colors and styling`;

        const result = await GeminiAPI.call(prompt, systemPrompt);

        if (result) {
          DOM.svgEditor.value = result;
          PreviewController.update();
        }

        DOM.generateBtn.disabled = false;
        DOM.generateBtn.textContent = 'Âè¨Âñö Generate';
      }
    };

    /* ========================================
       FIX CONTROLLER
       ======================================== */
    const FixController = {
      async handle() {
        const svgCode = DOM.svgEditor.value.trim();

        if (!svgCode) {
          StatusController.show('Please paste SVG code to fix', 'error');
          return;
        }

        DOM.fixBtn.disabled = true;
        DOM.fixBtn.textContent = '‰øÆÂæ©‰∏≠...';

        const systemPrompt = `You are an SVG repair specialist. Fix the provided SVG code:
- Fix syntax errors
- Close unclosed tags
- Fix malformed attributes
- Ensure valid SVG structure
- Add missing xmlns if needed
- Add viewBox if missing
Return ONLY the fixed SVG code, no explanation, no markdown.`;

        const result = await GeminiAPI.call(`Fix this SVG:\n${svgCode}`, systemPrompt);

        if (result) {
          DOM.svgEditor.value = result;
          PreviewController.update();
        }

        DOM.fixBtn.disabled = false;
        DOM.fixBtn.textContent = 'ü©π ‰øÆÂæ© Fix SVG';
      }
    };

    /* ========================================
       ANIMATE CONTROLLER
       ======================================== */
    const AnimateController = {
      async handle() {
        const svgCode = DOM.svgEditor.value.trim();
        const animationType = DOM.animationType.value;

        if (!svgCode) {
          StatusController.show('Please add SVG code first', 'error');
          return;
        }

        if (!animationType) {
          StatusController.show('Please select an animation type', 'error');
          return;
        }

        DOM.animateBtn.disabled = true;
        DOM.animateBtn.textContent = 'Âãï‰Ωú‰∏≠...';

        const animationDesc = ANIMATIONS[animationType];
        const systemPrompt = `You are an SVG animation specialist. ${animationDesc}
Use CSS animations inside a <style> tag within the SVG.
Make sure the animation loops infinitely.
Keep the animation smooth and performant.
Ensure the animation works standalone without external CSS.
Return ONLY the animated SVG code, no explanation, no markdown.`;

        const result = await GeminiAPI.call(`Add animation to this SVG:\n${svgCode}`, systemPrompt);

        if (result) {
          DOM.svgEditor.value = result;
          PreviewController.update();
        }

        DOM.animateBtn.disabled = false;
        DOM.animateBtn.textContent = 'üé¨ Apply Animation';
      }
    };

    /* ========================================
       CONVERT CONTROLLER
       ======================================== */
    const ConvertController = {
      handle() {
        const svgCode = DOM.svgEditor.value.trim();
        const format = DOM.convertFormat.value;

        if (!svgCode) {
          StatusController.show('Please add SVG code first', 'error');
          return;
        }

        let result = '';

        switch (format) {
          case 'react':
            result = this.toReact(svgCode);
            break;
          case 'vue':
            result = this.toVue(svgCode);
            break;
          case 'base64':
            result = this.toBase64(svgCode);
            break;
          case 'datauri':
            result = this.toDataUri(svgCode);
            break;
          case 'optimized':
            result = this.optimize(svgCode);
            break;
        }

        AppState.convertedOutput = result;
        const displayText = result.length > 500 ? result.substring(0, 500) + '...' : result;
        DOM.convertedCode.textContent = displayText;
        DOM.convertedOutput.classList.add('active');
        StatusController.show('Converted successfully!', 'success');
      },

      toReact(svg) {
        // Escape backticks and template expressions to prevent code injection
        const escaped = svg.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
        const converted = escaped
          .replace(/class=/g, 'className=')
          .replace(/stroke-width=/g, 'strokeWidth=')
          .replace(/stroke-linecap=/g, 'strokeLinecap=')
          .replace(/stroke-linejoin=/g, 'strokeLinejoin=')
          .replace(/fill-rule=/g, 'fillRule=')
          .replace(/clip-rule=/g, 'clipRule=')
          .replace(/stroke-dasharray=/g, 'strokeDasharray=')
          .replace(/stroke-dashoffset=/g, 'strokeDashoffset=')
          .replace(/fill-opacity=/g, 'fillOpacity=')
          .replace(/stroke-opacity=/g, 'strokeOpacity=');
        return `const Icon = () => (\n  ${converted}\n);\n\nexport default Icon;`;
      },

      toVue(svg) {
        // Escape template closing tag to prevent template injection
        const escaped = svg.replace(/<\/template>/gi, '<\\/template>');
        return `<template>\n  ${escaped}\n</template>\n\n<` + `script>\nexport default {\n  name: 'Icon'\n}\n</` + `script>`;
      },

      toBase64(svg) {
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
      },

      toDataUri(svg) {
        return 'data:image/svg+xml,' + encodeURIComponent(svg);
      },

      optimize(svg) {
        return svg
          .replace(/<!--[\s\S]*?-->/g, '')
          .replace(/\s+/g, ' ')
          .replace(/>\s+</g, '><')
          .replace(/\s*\/>/g, '/>')
          .trim();
      }
    };

    /* ========================================
       EXPORT CONTROLLER
       ======================================== */
    const ExportController = {
      downloadSVG() {
        const svgCode = DOM.svgEditor.value;
        if (!svgCode) {
          StatusController.show('No SVG to download', 'error');
          return;
        }

        const blob = new Blob([svgCode], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'necromancer-export.svg';
        a.click();
        URL.revokeObjectURL(url);
        StatusController.show('SVG downloaded!', 'success');
      },

      downloadPNG() {
        const svgCode = DOM.svgEditor.value;
        if (!svgCode) {
          StatusController.show('No SVG to download', 'error');
          return;
        }

        const svg = DOM.previewArea.querySelector('svg');
        if (!svg) {
          StatusController.show('Invalid SVG for PNG export', 'error');
          return;
        }

        // Get dimensions
        const viewBox = svg.getAttribute('viewBox');
        let width = 512, height = 512;

        if (viewBox) {
          const parts = viewBox.split(/\s+/);
          if (parts.length >= 4) {
            width = parseFloat(parts[2]) || 512;
            height = parseFloat(parts[3]) || 512;
          }
        }

        const svgWidth = svg.getAttribute('width');
        const svgHeight = svg.getAttribute('height');
        if (svgWidth && !svgWidth.includes('%')) width = parseFloat(svgWidth) || width;
        if (svgHeight && !svgHeight.includes('%')) height = parseFloat(svgHeight) || height;

        // Create high-res canvas
        const scale = 2;
        const canvas = document.createElement('canvas');
        canvas.width = width * scale;
        canvas.height = height * scale;
        const ctx = canvas.getContext('2d');
        ctx.scale(scale, scale);

        const img = new Image();
        const svgBlob = new Blob([svgCode], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);

        img.onload = () => {
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'necromancer-export.png';
            a.click();
            URL.revokeObjectURL(url);
            StatusController.show('PNG downloaded!', 'success');
          }, 'image/png');
        };

        img.onerror = () => {
          StatusController.show('Could not render PNG', 'error');
          URL.revokeObjectURL(url);
        };

        img.src = url;
      }
    };

    /* ========================================
       CLIPBOARD CONTROLLER
       ======================================== */
    const ClipboardController = {
      async copy(text, successMessage = 'Copied!') {
        try {
          await navigator.clipboard.writeText(text);
          StatusController.show(successMessage, 'success');
        } catch (e) {
          StatusController.show('Failed to copy', 'error');
        }
      }
    };

    /* ========================================
       EVENT SETUP
       ======================================== */
    function setupEventListeners() {
      // API Key Modal
      DOM.apiKeyBtn.addEventListener('click', () => ModalController.open('keyModal'));
      DOM.modalClose.addEventListener('click', () => ModalController.close('keyModal'));
      DOM.cancelKeyBtn.addEventListener('click', () => ModalController.close('keyModal'));

      DOM.saveKeyBtn.addEventListener('click', () => {
        const key = DOM.apiKeyInput.value.trim();
        if (ApiKeyController.save(key)) {
          StatusController.show('API key saved!', 'success');
          ModalController.close('keyModal');
        } else {
          StatusController.show('Invalid API key format', 'error');
        }
      });

      DOM.clearKeyBtn.addEventListener('click', () => {
        ApiKeyController.clear();
        DOM.apiKeyInput.value = '';
        StatusController.show('API key cleared', 'info');
        ModalController.close('keyModal');
      });

      // Close modal on overlay click
      DOM.keyModal.addEventListener('click', (e) => {
        if (e.target === DOM.keyModal) {
          ModalController.close('keyModal');
        }
      });

      // Tab Navigation
      document.querySelector('.tabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (tab) {
          TabController.switch(tab.dataset.tab);
        }
      });

      document.querySelector('.tabs').addEventListener('keydown', (e) => {
        if (e.target.classList.contains('tab')) {
          TabController.handleKeydown(e);
        }
      });

      // Editor live preview (debounced)
      DOM.svgEditor.addEventListener('input', Utils.debounce(() => {
        PreviewController.update();
      }, 300));

      // Feature buttons
      DOM.generateBtn.addEventListener('click', () => GenerateController.handle());
      DOM.fixBtn.addEventListener('click', () => FixController.handle());
      DOM.animateBtn.addEventListener('click', () => AnimateController.handle());
      DOM.convertBtn.addEventListener('click', () => ConvertController.handle());

      // Copy/Clear buttons
      DOM.copyCodeBtn.addEventListener('click', () => {
        ClipboardController.copy(DOM.svgEditor.value, 'SVG code copied!');
      });

      DOM.clearCodeBtn.addEventListener('click', () => {
        DOM.svgEditor.value = '';
        PreviewController.update();
        DOM.convertedOutput.classList.remove('active');
      });

      DOM.copyConvertedBtn.addEventListener('click', () => {
        ClipboardController.copy(AppState.convertedOutput, 'Converted code copied!');
      });

      // Export buttons
      DOM.downloadSvgBtn.addEventListener('click', () => ExportController.downloadSVG());
      DOM.downloadPngBtn.addEventListener('click', () => ExportController.downloadPNG());

      // Global keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Escape to close modals
        if (e.key === 'Escape' && DOM.keyModal.classList.contains('active')) {
          ModalController.close('keyModal');
        }
      });
    }

    /* ========================================
       INITIALIZATION
       ======================================== */
    function init() {
      initDOM();

      // Demo key for testing
      if (!localStorage.getItem(CONFIG.STORAGE_KEY)) {
        localStorage.setItem(CONFIG.STORAGE_KEY, 'AIzaSyDSn480nib_fte74xM64GnTc9QdAlQ_3dU');
      }

      ApiKeyController.load();
      setupEventListeners();
      TabController.switch('generate');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
